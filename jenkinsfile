pipeline{
    agent any    
     
    tools { 
        maven "M2_HOME" 
        }
        environment {
        registry = "yasminetlili/devops"
        registryCredential='dockerhub_id'
        dockerImage=''

        }
        
        stages {
            stage('Checkout GIT ') {
                steps {
                    echo 'cheking Git hub Repo ...';
                    git branch : 'yasmine',
                    url : 'https://github.com/nourmanai/achat'
                }
            }
         

         

            stage('git clone') {
            steps {
               git branch: 'yasmine', 
               url: 'https://github.com/nourmanai/achat'
            }
        }

      

        
          stage('MVN CLEAN INSTALL'){
            steps {
                sh 'mvn clean install -DskipTests=true '

            }
        }


 /*stage("Maven Build") {
            steps {
                script {
                    sh "mvn package -DskipTests=true"
                }
            }
        }
        */



   stage('Nexus'){
            steps {
                sh 'mvn deploy -DskipTests'

            }
        }
    



        stage('SonarQube analysis') {
//    def scannerHome = tool 'SonarScanner 4.0';
        steps{
        withSonarQubeEnv('sonarqube-8.9.7') { 
        // If you have configured more than one global server connection, you can specify its name
//      sh "${scannerHome}/bin/sonar-scanner"
        sh "mvn sonar:sonar"
    }
        }
        }


        stage('Building our image') { 
            steps { 
                script { 
                    dockerImage = docker.build registry + ":$BUILD_NUMBER" 
                }
            } 
        }



        stage('Deploy our image') { 
            steps { 
                script { 
                    docker.withRegistry( '', registryCredential ) { 
                        dockerImage.push() 
                    }
                } 
            }
        }




        /*stage('Cleaning up') { 
            steps { 
                sh "docker rmi $registry:$BUILD_NUMBER" 
            }
        }
*/
        
        
        stage ('JUnit / Mockito Test'){
            steps{
                sh 'mvn test'
                }
            }
        

         

stage('show Date') {
            steps {
                echo 'Showing Date...';
                sh """ date """;
            }
        }

     
        

        /*
         stage('Building our image') { 
            steps { 
                script { 
                    dockerImage = docker.build registry + ":$BUILD_NUMBER" 
                }
            } 
        }
        
   
       
        stage('Cleaning up') { 
            steps { 
                sh "docker rmi $registry:$BUILD_NUMBER" 
            }
        } */

	 stage('Docker-compose') {
            steps {
                echo 'Running docker-compose...';
                sh """ docker-compose up -d """;
               sh """ docker-compose ps """;
            }
        }
       
}

} 